- Load Balancers are servers that forward traffic to multiple servers (e.g., [[EC2]] instances) downstream
## Why use a load balancer? 
- Spread load across multiple downstream instances 
- Expose a single point of access (DNS) to your application 
- Seamlessly handle failures of downstream instances 
- Do regular health checks to your instances 
- Provide SSL termination (HTTPS) for your websites 
- Enforce stickiness with cookies 
- High availability across zones 
- Separate public traffic from private traffic

## Why use an Elastic Load Balancer?
an Elastic load balancer is managed load balancer
it is integrated with many AWS offering
- EC2, [[EC2 Auto Scaling Groups]], [[ECS]]
- Aws Certeficate Manager, [[CloudWatch]]
- [[Route53]], [[AWS WAF]], AWS Global Accelerator
## Health checks
- They enable the load balancer to know if instances it forwards traffic to are available to reply to request
- The health check is done on a port and a route (/health is common) 
- If the response is not 200 (OK), then the instance is unhealthy

## Types of load balancer on AWS
- Classic Load Balancer (v1 - old generation) – 2009 – CLB 
	- HTTP, HTTPS, TCP, SSL (secure TCP) 
- Application Load Balancer (v2 - new generation) – 2016 – ALB 
	- HTTP, HTTPS, WebSocket 
	- multiple HTTP applications across machines (target groups)
	- multiple applications on the same machine (containers)
	- ALB are a great fit for micro services & container-based application
	- Has a port mapping feature to redirect to a dynamic port in ECS 
	- In comparison, we’d need multiple Classic Load Balancer per application
	- Target Groups : EC2, ECS tasks, Lambda functions, IP Adresses - must be private IPs,
	- The application servers don’t see the IP of the client directly • The true IP of the client is inserted in the header X-Forwarded-For
	- ALBs can route traffic to different Target Groups based on URL Path, Hostname, HTTP Headers, and Query Strings.
- Network Load Balancer (v2 - new generation) – 2017 – NLB 
	- TCP, TLS (secure TCP), UDP
	- Handle millions of request per seconds , Ultra-low latency
	- NLB has one static IP per AZ , and supports assigning Elastic IP (helpful for whitelisting specific IP)
	- Target Groups : EC2, IP Adresses - must be private IPs, ALB
- Gateway Load Balancer – 2020 – GWLB 
	- Operates at layer 3 (Network layer) – IP Protocol
	- Deploy, scale, and manage a fleet of 3rd party network virtual appliances in AWS
	- Example: Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation, …
	- Combines the following functions: • Transparent Network Gateway – single entry/exit for all traffic • Load Balancer – distributes traffic to your virtual appliances 
	- Uses the GENEVE protocol on port 6081
	- Target Groups : EC2, IP Adresses - must be private IP

Some load balancers can be setup as internal (private) or external (public) ELBs

## Load Balancer Security Groups

![[Screenshot 2024-11-23 110635.png]]

## Sticky Sessions

- stickiness enables the redirection of the client to the same instance behind the load balancer.
- This works for CLB, ALB and NLB. For both CLB & ALB, the “cookie” used for stickiness has an expiration date you control
- Use case: make sure the user doesn’t lose his session data
### Cookie Names
- Application based cookies:
	- Custom cookie: 
		- Generated by the target 
		- Can include any custom attributes required by the application 
		- Cookie name must be specified individually for each target group 
		- Don’t use AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by the ELB)
	- Application cookie 
		- Generated by the load balancer 
		- Cookie name is AWSALBAPP
- Duration-based Cookies 
	- Cookie generated by the load balancer 
	- Cookie name is AWSALB for ALB, AWSELB for CLB
## Cross-Zone Load Balancing
![[Screenshot 2024-11-25 085940.png]]

ALB : Enabled by default, can be disable at the target group level, no charges for inter AZ data
NLB, GLB : Disabled by default, you pay charges
CLB : Disabled by default, no charges

## SSL/TLS Basics
- An SSL Certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption), it has an expiration date (you set) and must be renewed
- SSL refers to Secure Sockets Layer, used to encrypt connections 
- TLS refers to Transport Layer Security, which is a newer version 
- Nowadays, TLS certificates are mainly used, but people still refer as SSL
- You can manage certificates using ACM (AWS Certificate Manager)
- HTTPS listener: 
	- You must specify a default certificate 
	- You can add an optional list of certs to support multiple domains 
	- Clients can use SNI (Server Name Indication) to specify the hostname they reach 
	- Ability to specify a security policy to support older versions of SSL / TLS (legacy clients
### SSL – Server Name Indication (SNI)
- SNI solves the problem of loading multiple SSL certificates onto one web server (to serve multiple websites)
- It’s a “newer” protocol, and requires the client to indicate the hostname of the target server in the initial SSL handshake 
- The server will then find the correct certificate, or return the default one
- Only works for ALB & NLB (newer generation), CloudFront

### Elastic Load Balancers – SSL Certificates
- Classic Load Balancer (v1) 
	- Support only one SSL certificate 
	- Must use multiple CLB for multiple hostname with multiple SSL certificates 
- Application and Network Load Balancer a (v2) 
	- Supports multiple listeners with multiple SSL certificates 
	- Uses Server Name Indication (SNI) to make it work

## Connection Draining
Feature naming 
	- Connection Draining – for CLB 
	- Deregistration Delay – for ALB & NLB
- Time to complete “in-flight requests” while the instance is de-registering or unhealthy 
- Stops sending new requests to the EC2 instance which is de-registering 
- Between 1 to 3600 seconds (default: 300 seconds) 
- Can be disabled (set value to 0) 
- Set to a low value if your requests are short